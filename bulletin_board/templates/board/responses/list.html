{% extends 'base.html' %}
{% load static %}

{% block title %}Мои отклики - MMORPG Форум{% endblock %}

{% block content %}
<div class="container py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'ad_list' %}">Главная</a></li>
            <li class="breadcrumb-item active">Мои отклики</li>
        </ol>
    </nav>
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="fas fa-comments me-2 text-primary"></i>Отклики
            </h1>
            <p class="text-muted mb-0">Управление откликами на ваши объявления</p>
        </div>
        <div class="d-flex gap-3">
            <div class="text-center">
                <div class="fs-4 fw-bold text-primary">{{ total_responses }}</div>
                <div class="small text-muted">Всего</div>
            </div>
            <div class="text-center">
                <div class="fs-4 fw-bold text-success">{{ accepted_responses }}</div>
                <div class="small text-muted">Принято</div>
            </div>
            <div class="text-center">
                <div class="fs-4 fw-bold text-warning">{{ pending_responses }}</div>
                <div class="small text-muted">Ожидает</div>
            </div>
        </div>
    </div>
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label class="form-label small fw-bold">Фильтр:</label>
                    <select name="filter" class="form-select" onchange="this.form.submit()">
                        <option value="all" {% if filter_type == 'all' %}selected{% endif %}>
                            Все отклики
                        </option>
                        <option value="accepted" {% if filter_type == 'accepted' %}selected{% endif %}>
                            Только принятые
                        </option>
                        <option value="pending" {% if filter_type == 'pending' %}selected{% endif %}>
                            Только ожидающие
                        </option>
                        <option value="my" {% if filter_type == 'my' %}selected{% endif %}>
                            Мои отклики
                        </option>
                    </select>
                </div>

                <div class="col-md-5">
                    <label class="form-label small fw-bold">Поиск:</label>
                    <div class="input-group">
                        <input type="text"
                               name="search"
                               class="form-control"
                               placeholder="Поиск по тексту, объявлению или пользователю..."
                               value="{{ search_query }}">
                        {% if search_query %}
                        <a href="?" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>

                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>Найти
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if responses %}
    <div class="card shadow-sm">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 40%;">Отклик / Объявление</th>
                        <th style="width: 20%;">Пользователь</th>
                        <th style="width: 20%;">Дата</th>
                        <th style="width: 10%;">Статус</th>
                        <th style="width: 10%;" class="text-end">Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for response in responses %}
                    <tr>
                        <td>
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    {% if response.ad.image %}
                                    <img src="{{ response.ad.image.url }}"
                                         alt="{{ response.ad.title }}"
                                         class="rounded"
                                         style="width: 50px; height: 50px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-secondary rounded d-flex align-items-center justify-content-center"
                                         style="width: 50px; height: 50px;">
                                        <i class="fas fa-bullhorn text-light opacity-50"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="mb-1">
                                        <a href="{% url 'ad_detail' response.ad.pk %}"
                                           class="text-decoration-none">
                                            {{ response.ad.title|truncatechars:50 }}
                                        </a>
                                    </h6>
                                    <p class="mb-0 small text-muted">
                                        {{ response.text|truncatechars:100 }}
                                    </p>
                                    <small class="text-muted">
                                        Категория: {{ response.ad.category.name }}
                                    </small>
                                </div>
                            </div>
                        </td>

                        <td>
                            <div class="d-flex align-items-center">
                                {% if response.from_user.profile.avatar %}
                                <img src="{{ response.from_user.profile.avatar.url }}"
                                     alt="{{ response.from_user.username }}"
                                     class="rounded-circle me-2"
                                     style="width: 32px; height: 32px; object-fit: cover;">
                                {% else %}
                                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-2"
                                     style="width: 32px; height: 32px;">
                                    <span class="text-white small">
                                        {{ response.from_user.username|first|upper }}
                                    </span>
                                </div>
                                {% endif %}
                                <div>
                                    <div class="fw-bold">{{ response.from_user.username }}</div>
                                    {% if response.from_user.profile.location %}
                                    <small class="text-muted">{{ response.from_user.profile.location }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </td>

                        <td>
                            <div class="small">
                                <div class="fw-bold">{{ response.created_at|date:"d.m.Y" }}</div>
                                <div class="text-muted">{{ response.created_at|time:"H:i" }}</div>
                            </div>
                        </td>

                        <td>
                            {% if response.is_accepted %}
                            <span class="badge bg-success">
                                <i class="fas fa-check me-1"></i>Принят
                            </span>
                            {% else %}
                            <span class="badge bg-warning">
                                <i class="fas fa-clock me-1"></i>Ожидает
                            </span>
                            {% endif %}
                        </td>

                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'response_detail' response.pk %}"
                                   class="btn btn-outline-primary"
                                   title="Просмотреть">
                                    <i class="fas fa-eye"></i>
                                </a>

                                {% if response.ad.author == user and not response.is_accepted %}
                                <a href="{% url 'accept_response' response.pk %}"
                                   class="btn btn-outline-success"
                                   title="Принять отклик"
                                   onclick="return confirm('Принять этот отклик?');">
                                    <i class="fas fa-check"></i>
                                </a>
                                {% endif %}

                                <a href="{% url 'delete_response' response.pk %}"
                                   class="btn btn-outline-danger"
                                   title="Удалить отклик">
                                    <i class="fas fa-trash"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% if page_obj.has_other_pages %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% if filter_type %}&filter={{ filter_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if filter_type %}&filter={{ filter_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                </li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if filter_type %}&filter={{ filter_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
                        {{ num }}
                    </a>
                </li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if filter_type %}&filter={{ filter_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if filter_type %}&filter={{ filter_type }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="card shadow-sm border-0">
        <div class="card-body text-center py-5">
            <div class="mb-4">
                <i class="fas fa-comments fa-4x text-muted opacity-25"></i>
            </div>

            {% if filter_type == 'all' and not search_query %}
            <h3 class="h4 mb-3">Пока нет откликов</h3>
            <p class="text-muted mb-4">
                Создайте объявление и ждите откликов от других пользователей
            </p>
            <a href="{% url 'ad_create' %}" class="btn btn-primary">
                <i class="fas fa-plus-circle me-2"></i>Создать объявление
            </a>
            {% else %}
            <h3 class="h4 mb-3">Ничего не найдено</h3>
            <p class="text-muted mb-4">
                Попробуйте изменить параметры поиска или сбросить фильтры
            </p>
            <a href="?" class="btn btn-outline-primary">
                <i class="fas fa-redo me-2"></i>Сбросить фильтры
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="row mt-5">
        <div class="col-md-4 mb-3">
            <div class="card border-primary border-2 h-100">
                <div class="card-body text-center">
                    <i class="fas fa-bullhorn fa-2x text-primary mb-3"></i>
                    <h5 class="card-title">Ваши объявления</h5>
                    <p class="card-text small text-muted">
                        Просмотр и управление вашими объявлениями
                    </p>
                    <a href="?filter=my" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-2"></i>Показать
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card border-success border-2 h-100">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                    <h5 class="card-title">Принятые отклики</h5>
                    <p class="card-text small text-muted">
                        Отклики, которые вы уже приняли
                    </p>
                    <a href="?filter=accepted" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-filter me-2"></i>Фильтр
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card border-warning border-2 h-100">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x text-warning mb-3"></i>
                    <h5 class="card-title">Ожидающие отклики</h5>
                    <p class="card-text small text-muted">
                        Отклики, требующие вашего внимания
                    </p>
                    <a href="?filter=pending" class="btn btn-outline-warning btn-sm">
                        <i class="fas fa-inbox me-2"></i>Просмотр
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .table > :not(caption) > * > * {
        padding: 1rem 1rem;
        vertical-align: middle;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    .badge {
        padding: 0.4em 0.8em;
        font-size: 0.85em;
    }

    .btn-group-sm > .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.2rem;
    }

    .card {
        border-radius: 12px;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const acceptButtons = document.querySelectorAll('a[href*="accept_response"]');
        acceptButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                if (!confirm('Принять этот отклик?')) {
                    e.preventDefault();
                }
            });
        });

        const filterSelect = document.querySelector('select[name="filter"]');
        if (filterSelect) {
            filterSelect.addEventListener('change', function() {
                this.form.submit();
            });
        }

        document.querySelectorAll('tbody tr').forEach(row => {
            const statusBadge = row.querySelector('.badge');
            if (statusBadge && statusBadge.classList.contains('bg-warning')) {
                row.classList.add('table-warning');
                row.classList.add('opacity-75');
            }
        });
    });
</script>
{% endblock %}